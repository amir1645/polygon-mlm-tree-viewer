<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نمایشگر درختی شبکه MLM - پالیگان</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Persian Font and RTL Support */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background-color: #f5f7fb;
            line-height: 1.6;
        }

        .card {
            border: none;
            border-radius: 12px;
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        #treeVisualization {
            position: relative;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }

        .node-circle {
            stroke: #fff;
            stroke-width: 2px;
        }

        .node-left {
            fill: #4e73df;
        }

        .node-right {
            fill: #1cc88a;
        }

        .node-current {
            fill: #f6c23e;
        }

        .node-text {
            font-size: 12px;
            fill: #fff;
            text-anchor: middle;
            pointer-events: none;
            font-weight: 600;
        }

        .link {
            fill: none;
            stroke: #b0b0b0;
            stroke-width: 2px;
            opacity: 0.6;
        }

        .badge {
            font-weight: 500;
            padding: 0.5em 0.8em;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            #treeContainer {
                height: 400px !important;
            }
            
            .card-body {
                padding: 1rem;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .branch-left {
            border-right: 4px solid #4e73df;
            background: rgba(78, 115, 223, 0.1);
        }

        .branch-right {
            border-right: 4px solid #1cc88a;
            background: rgba(28, 200, 138, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-diagram-3-fill me-2"></i>
                شبکه درختی MLM
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item">
                    <span id="networkInfo" class="badge bg-light text-dark">
                        <i class="bi bi-hdd-network me-1"></i>
                        پالیگان
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mt-4">
        <!-- Wallet Connection Section -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-wallet2 me-2"></i>
                            اتصال کیف پول
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="walletSection">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                برای مشاهده شبکه خود، ابتدا کیف پول خود را متصل کنید
                            </div>
                            <button id="connectWallet" class="btn btn-primary btn-lg">
                                <i class="bi bi-plug me-2"></i>
                                اتصال کیف پول
                            </button>
                        </div>
                        <div id="connectedWallet" class="d-none">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-check-circle me-1"></i>
                                        متصل
                                    </span>
                                    <span id="walletAddress" class="text-muted"></span>
                                </div>
                                <button id="disconnectWallet" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-power me-1"></i>
                                    قطع ارتباط
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Info Section -->
        <div id="userInfoSection" class="row mt-4 d-none">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person-badge me-2"></i>
                            اطلاعات کاربر
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="userInfoContent">
                            <!-- User info will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tree Visualization Section -->
        <div id="treeSection" class="row mt-4 d-none">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-diagram-3 me-2"></i>
                            نمودار درختی شبکه
                        </h5>
                        <div class="btn-group">
                            <button id="zoomIn" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button id="zoomOut" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                            <button id="resetView" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="treeContainer" style="height: 600px; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
                            <div id="treeVisualization" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center mt-4 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">در حال بارگذاری...</span>
            </div>
            <p class="mt-2 text-muted">در حال بارگذاری اطلاعات شبکه...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    
    <!-- Ethers.js from CDN that works -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>
    
    <script>
        // Configuration
        const CONTRACT_ADDRESS = "0x166dd205590240c90ca4e0e545ad69db47d8f22f";
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "address","name": "user","type": "address"}],
                "name": "getUserInfo",
                "outputs": [
                    {"internalType": "uint256","name": "id","type": "uint256"},
                    {"internalType": "uint256","name": "uplineId","type": "uint256"},
                    {"internalType": "uint256","name": "leftCount","type": "uint256"},
                    {"internalType": "uint256","name": "rightCount","type": "uint256"},
                    {"internalType": "uint256","name": "saveLeft","type": "uint256"},
                    {"internalType": "uint256","name": "saveRight","type": "uint256"},
                    {"internalType": "uint256","name": "balanceCount","type": "uint256"},
                    {"internalType": "uint256","name": "specialBalanceCount","type": "uint256"},
                    {"internalType": "uint256","name": "totalMinerRewards","type": "uint256"},
                    {"internalType": "uint256","name": "entryPrice","type": "uint256"},
                    {"internalType": "bool","name": "isMiner","type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "userId","type": "uint256"}],
                "name": "getUserDirects",
                "outputs": [
                    {"internalType": "uint256","name": "leftId","type": "uint256"},
                    {"internalType": "uint256","name": "rightId","type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalUsers",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        class MLMTreeViewer {
            constructor() {
                this.provider = null;
                this.signer = null;
                this.contract = null;
                this.userAddress = null;
                this.treeData = null;
                this.svg = null;
                this.zoom = null;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkWalletConnection();
            }

            bindEvents() {
                document.getElementById('connectWallet').addEventListener('click', () => this.connectWallet());
                document.getElementById('disconnectWallet').addEventListener('click', () => this.disconnectWallet());
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetView').addEventListener('click', () => this.resetView());
            }

            async checkWalletConnection() {
                if (window.ethereum) {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) {
                            await this.handleWalletConnected(accounts[0]);
                        }
                    } catch (error) {
                        console.error('Error checking wallet connection:', error);
                    }
                }
            }

            async connectWallet() {
                try {
                    if (!window.ethereum) {
                        throw new Error('لطفا متامسک یا کیف پول مشابه را نصب کنید');
                    }

                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });

                    await this.handleWalletConnected(accounts[0]);

                    // Listen for account changes
                    window.ethereum.on('accountsChanged', (accounts) => {
                        if (accounts.length === 0) {
                            this.disconnectWallet();
                        } else {
                            this.handleWalletConnected(accounts[0]);
                        }
                    });

                } catch (error) {
                    this.showError('خطا در اتصال کیف پول: ' + error.message);
                }
            }

            async handleWalletConnected(address) {
                this.userAddress = address;
                
                // Update UI
                document.getElementById('walletSection').classList.add('d-none');
                document.getElementById('connectedWallet').classList.remove('d-none');
                document.getElementById('walletAddress').textContent = 
                    `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;

                // Initialize provider and contract
                this.provider = new ethers.providers.Web3Provider(window.ethereum);
                this.signer = this.provider.getSigner();
                this.contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, this.signer);

                // Load user data and tree
                await this.loadUserData();
                await this.loadTreeVisualization();
            }

            disconnectWallet() {
                this.userAddress = null;
                this.provider = null;
                this.signer = null;
                this.contract = null;
                
                // Reset UI
                document.getElementById('walletSection').classList.remove('d-none');
                document.getElementById('connectedWallet').classList.add('d-none');
                document.getElementById('userInfoSection').classList.add('d-none');
                document.getElementById('treeSection').classList.add('d-none');
                
                // Clear tree visualization
                const treeContainer = document.getElementById('treeVisualization');
                if (treeContainer) {
                    treeContainer.innerHTML = '';
                }
            }

            async loadUserData() {
                try {
                    this.showLoading(true);
                    
                    const userInfo = await this.contract.getUserInfo(this.userAddress);
                    
                    const userInfoHTML = `
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">${userInfo.id.toString()}</div>
                                <div class="stat-label">شناسه کاربری</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);">
                                <div class="stat-number">${userInfo.leftCount.toString()}</div>
                                <div class="stat-label">اعضای چپ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);">
                                <div class="stat-number">${userInfo.rightCount.toString()}</div>
                                <div class="stat-label">اعضای راست</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);">
                                <div class="stat-number">${userInfo.balanceCount.toString()}</div>
                                <div class="stat-label">تعداد بالانس</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('userInfoContent').innerHTML = userInfoHTML;
                    document.getElementById('userInfoSection').classList.remove('d-none');
                    
                } catch (error) {
                    this.showError('خطا در دریافت اطلاعات کاربر: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async loadTreeVisualization() {
                try {
                    this.showLoading(true);
                    
                    // Build tree data starting from current user
                    this.treeData = await this.buildTreeData(this.userAddress);
                    
                    // Create D3 tree visualization
                    this.createTreeVisualization();
                    
                    document.getElementById('treeSection').classList.remove('d-none');
                    
                } catch (error) {
                    this.showError('خطا در ایجاد نمودار درختی: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async buildTreeData(userAddress, depth = 0, maxDepth = 3) {
                if (depth >= maxDepth) return null;

                try {
                    const userInfo = await this.contract.getUserInfo(userAddress);
                    const directs = await this.contract.getUserDirects(userInfo.id);

                    const node = {
                        name: `User ${userInfo.id}`,
                        id: userInfo.id.toString(),
                        address: userAddress,
                        leftCount: userInfo.leftCount.toString(),
                        rightCount: userInfo.rightCount.toString(),
                        balanceCount: userInfo.balanceCount.toString(),
                        isCurrent: userAddress.toLowerCase() === this.userAddress.toLowerCase(),
                        children: []
                    };

                    // Recursively build left branch
                    if (directs.leftId !== 0) {
                        const leftUserAddress = await this.getUserAddressById(directs.leftId);
                        if (leftUserAddress) {
                            const leftChild = await this.buildTreeData(leftUserAddress, depth + 1, maxDepth);
                            if (leftChild) {
                                leftChild.branch = 'left';
                                node.children.push(leftChild);
                            }
                        }
                    }

                    // Recursively build right branch
                    if (directs.rightId !== 0) {
                        const rightUserAddress = await this.getUserAddressById(directs.rightId);
                        if (rightUserAddress) {
                            const rightChild = await this.buildTreeData(rightUserAddress, depth + 1, maxDepth);
                            if (rightChild) {
                                rightChild.branch = 'right';
                                node.children.push(rightChild);
                            }
                        }
                    }

                    return node;

                } catch (error) {
                    console.error('Error building tree node:', error);
                    return null;
                }
            }

            async getUserAddressById(userId) {
                // For demo - in real implementation you'd need a mapping function
                try {
                    // This is a placeholder - you'll need to implement based on your contract
                    return `0x${userId.toString().padStart(40, '0')}`;
                } catch (error) {
                    console.error('Error getting user address:', error);
                    return null;
                }
            }

            createTreeVisualization() {
                const container = document.getElementById('treeVisualization');
                if (!container) return;
                
                container.innerHTML = '';

                const width = container.clientWidth;
                const height = container.clientHeight;

                this.svg = d3.select('#treeVisualization')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                const g = this.svg.append('g');

                // Create tree layout
                const treeLayout = d3.tree()
                    .size([height - 100, width - 200]);

                const hierarchy = d3.hierarchy(this.treeData);
                const treeData = treeLayout(hierarchy);

                // Add zoom capability
                this.zoom = d3.zoom()
                    .scaleExtent([0.1, 2])
                    .on('zoom', (event) => {
                        g.attr('transform', event.transform);
                    });

                this.svg.call(this.zoom);

                // Create links
                const links = g.selectAll('.link')
                    .data(treeData.links())
                    .enter()
                    .append('path')
                    .attr('class', 'link')
                    .attr('d', d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x)
                    );

                // Create nodes
                const nodes = g.selectAll('.node')
                    .data(treeData.descendants())
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.y},${d.x})`);

                // Add circles to nodes
                nodes.append('circle')
                    .attr('class', d => {
                        let className = 'node-circle';
                        if (d.data.isCurrent) {
                            className += ' node-current';
                        } else if (d.data.branch === 'left') {
                            className += ' node-left';
                        } else if (d.data.branch === 'right') {
                            className += ' node-right';
                        }
                        return className;
                    })
                    .attr('r', 25)
                    .on('click', (event, d) => this.nodeClicked(d));

                // Add text to nodes
                nodes.append('text')
                    .attr('class', 'node-text')
                    .attr('dy', 4)
                    .text(d => d.data.id)
                    .on('click', (event, d) => this.nodeClicked(d));

                // Add tooltips
                nodes.append('title')
                    .text(d => 
                        `User ${d.data.id}\nLeft: ${d.data.leftCount}\nRight: ${d.data.rightCount}\nBalance: ${d.data.balanceCount}`
                    );

                // Center the tree
                const bounds = g.node().getBBox();
                const fullWidth = width;
                const fullHeight = height;
                const widthScale = (fullWidth - 200) / bounds.width;
                const heightScale = (fullHeight - 100) / bounds.height;
                const scale = Math.min(widthScale, heightScale) * 0.8;

                const transform = d3.zoomIdentity
                    .translate(fullWidth / 2, fullHeight / 2)
                    .scale(scale)
                    .translate(-bounds.x - bounds.width / 2, -bounds.y - bounds.height / 2);

                this.svg.transition()
                    .duration(750)
                    .call(this.zoom.transform, transform);
            }

            nodeClicked(node) {
                console.log('Node clicked:', node.data);
                // You can implement additional functionality here
            }

            zoomIn() {
                if (this.svg && this.zoom) {
                    this.svg.transition()
                        .duration(300)
                        .call(this.zoom.scaleBy, 1.3);
                }
            }

            zoomOut() {
                if (this.svg && this.zoom) {
                    this.svg.transition()
                        .duration(300)
                        .call(this.zoom.scaleBy, 0.7);
                }
            }

            resetView() {
                const container = document.getElementById('treeVisualization');
                if (!container || !this.svg) return;

                const width = container.clientWidth;
                const height = container.clientHeight;

                const g = this.svg.select('g');
                const bounds = g.node().getBBox();
                
                const widthScale = (width - 200) / bounds.width;
                const heightScale = (height - 100) / bounds.height;
                const scale = Math.min(widthScale, heightScale) * 0.8;

                const transform = d3.zoomIdentity
                    .translate(width / 2, height / 2)
                    .scale(scale)
                    .translate(-bounds.x - bounds.width / 2, -bounds.y - bounds.height / 2);

                this.svg.transition()
                    .duration(750)
                    .call(this.zoom.transform, transform);
            }

            showLoading(show) {
                const loadingElement = document.getElementById('loadingSpinner');
                if (show) {
                    loadingElement.classList.remove('d-none');
                } else {
                    loadingElement.classList.add('d-none');
                }
            }

            showError(message) {
                alert(message);
                console.error(message);
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MLMTreeViewer();
        });
    </script>
</body>
</html>